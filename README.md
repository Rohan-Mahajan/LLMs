# LLMs

def get_solution_with_feedback(error_message):
    result = agent.invoke({"input": error_message.strip()})
    
    # If no match is found, return the error message and exit
    if "No matching defect found" in result["response"]:
        print(result["response"])
        return
    
    print(result["response"])

    # Collect rating only if a solution is provided
    while True:
        try:
            rating = int(input("Rate the solution (1-5): "))
            if rating < 1 or rating > 5:
                print("Invalid rating. Please enter a number between 1 and 5.")
                continue
        except ValueError:
            print("Invalid input. Please enter a number between 1 and 5.")
            continue

        collect_feedback(error_message, result["response"], rating)

        # If rating is below 3, generate an alternative solution and test cases
        if rating < 3:
            print("\nGenerating an alternative solution...\n")

            alternative_prompt = """
            [INST] Provide a concise and actionable alternative solution for the following error:
            Error: {error}
            Ensure the solution is clear and does not include any follow-up questions or requests for clarification.
            [/INST]
            """
            alternative_solution = llm.invoke(ChatPromptTemplate.from_template(alternative_prompt).format(
                error=error_message
            )).content.strip()

            test_case_prompt = """
            [INST] Given this error and the new solution:
            Error: {error}
            Solution: {solution}
            Generate **exactly** 2 structured test cases...
            [/INST]
            """
            generated_test_cases = llm.invoke(ChatPromptTemplate.from_template(test_case_prompt).format(
                error=error_message,
                solution=alternative_solution
            )).content.strip()

            print(f"**Alternative Solution (Generated by Agent):**\n{alternative_solution}")
            print(f"\n**Generated Test Cases (Generated by Agent):**\n{generated_test_cases}")

            collect_feedback(error_message, alternative_solution, rating)
        else:
            print("Thank you for your feedback!")
        
        break
